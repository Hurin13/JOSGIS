{% extends 'base.html' %}
{% block title %}Land Data{% endblock %}

{% block content %}
<h2>Add Farm</h2>

<form method="POST" enctype="multipart/form-data">
    <input type="text" name="nama" placeholder="Farm Name" required>

    <!-- Luas otomatis -->
    <input type="number" step="0.01" name="luas_lahan" id="luas_lahan" placeholder="Area (ha)" readonly required>

    <input type="number" name="tahun_tanam" placeholder="Planting Year" required>

    <!-- Dropdown varietas -->
    <select name="varietas_kakao" required>
        <option value="" disabled selected>Select Cocoa Variety</option>
        <option value="Criollo">Criollo</option>
        <option value="Forastero">Forastero</option>
        <option value="Trinitario">Trinitario</option>
    </select>

    <!-- Upload bukti -->
    <label>Upload Certificate (optional):</label>
    <input type="file" name="sertifikat" accept="image/*">

    <input type="hidden" name="geojson" id="titik_ordinat" required>

    <div id="map" style="height: 400px; margin-top: 10px;"></div>

    <button type="submit">Save Farm</button>
</form>

<hr>
<h3>Your Farms:</h3>
<ul>
    {% for lahan in lahan_list %}
        <li>
            {{ lahan.nama_lahan }} - {{ lahan.luas_lahan }} ha ({{ lahan.tahun_tanam }})<br>
            Variety: {{ lahan.varietas_kakao }}<br>
            {% if lahan.bukti_luas_sertifikat %}
                Certificate: <a href="{{ url_for('static', filename=lahan.bukti_luas_sertifikat.split('static/')[-1]) }}" target="_blank">View</a>
            {% else %}
                No certificate
            {% endif %}
        </li>
    {% else %}
        <p>No farm data yet.</p>
    {% endfor %}
</ul>

<!-- Leaflet dan Draw -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>

<script>
    var map = L.map('map').setView([-8.2981, 114.1323], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    var drawControl = new L.Control.Draw({
        draw: {
            marker: false,
            polyline: false,
            circle: false,
            rectangle: false,
            circlemarker: false,
            polygon: {
                allowIntersection: false,
                showArea: true
            }
        },
        edit: {
            featureGroup: drawnItems
        }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
        var layer = e.layer;
        drawnItems.clearLayers(); // hanya satu polygon
        drawnItems.addLayer(layer);

        var geojson = JSON.stringify(layer.toGeoJSON().geometry);
        document.getElementById('titik_ordinat').value = geojson;

        var area_m2 = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
        var area_ha = area_m2 / 10000;
        document.getElementById('luas_lahan').value = area_ha.toFixed(2);
    });
</script>
{% endblock %}
